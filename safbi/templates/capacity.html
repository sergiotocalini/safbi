{% extends "base.html" %}

{% block title %}Capacity{% endblock %}

{% block body %}
<div class="section-refresh fade in disabled"
     style="width:100%;height:100%;opacity:0.7;background-color:#dedede;position:absolute;z-index:10;">
  <i class="fa fa-5x fa-spinner fa-spin"
     style="top:48%;left:48%;transform: translateY(-50%) translateX(-50%);position:absolute"></i>
</div>
<div class="capacity-header section-header">
  <div class="section-title title">
    <i class="fa fa-fw fa-binoculars" aria-hidden="true"></i>
    Capacity
  </div>
  <div class="section-toolbar toolbar pull-right">
    <a data-init="true" href="#reload" data-click="section-reload"
       class="fa fa-2x fa-sync" aria-disabled="true" title="Reload">
    </a>
    <a data-init="true" href="#filter" data-click="section-filter"
       class="fa fa-2x fa-filter" aria-disabled="true" title="Filter">
    </a>
    <a data-init="true" href="#fullscreen" data-click="section-fullscreen"
       class="fa fa-2x fa-expand-arrows-alt" aria-disabled="true" title="Fullscreen">
    </a>
    <a data-init="true" href="#simulation" data-click="section-simulation"
       class="fa fa-2x fa-crosshairs" aria-disabled="true" title="Simulation">
    </a>
  </div>
</div>
<div class="capacity-content section-content" style="background: #f1f2f7;">
  <div class="grid-stack" data-gs-animate="true">
    <div class="grid-stack-item" data-gs-width="12" data-gs-height="4" data-gs-no-move="true"
	 data-gs-no-resize="true" data-gs-x="0">
      <div class="panel" style="right:0px;left:0px;">
	<header class="panel-heading"
		style="border-color: #eff2f7;font-size: 13px;font-weight: 400;
		       background: #fafafa;text-transform: uppercase;padding: 15px;">
	  Overview
	</header>
	<div class="panel-body">
	  <div class="grid-stack-item-content" style="height:100%;width:100%;">
	    <div id="graph-overview-perf" class="col-md-4"></div>
	    <div class="divider-vertical"></div>
	    <div id="graph-overview-info" class="col-md-8">
	      <ul style="list-style: none;">
		<li id="overview-hosts-count"><h3>0</h3><span>Hosts</span></li>
		<li id="overview-vms-count"><h3>0</h3><span>Virtual Machines</span></li>
	      </ul>
	    </div>
	  </div>	  
	</div>
      </div>
    </div>
    <div class="grid-stack-item" data-gs-width="12" data-gs-height="12" data-gs-no-move="true"
         data-gs-no-resize="true" data-gs-x="6">
      <div class="panel" style="right:0px;left:0px;">
	<header class="panel-heading"
		style="border-color: #eff2f7;font-size: 13px;font-weight: 400;
		       background: #fafafa;text-transform: uppercase;padding: 15px;">
	  Details
	</header>
	<div class="panel-body">
	  <div class="grid-stack-item-content" style="height:100%;width:100%;">
	    <div id="details-content" class="table-responsive" style="min-height: 500px;"></div>
	  </div>
	</div>
      </div>
    </div>
  </div>
</div>   
{% endblock %}

{% block modals %}
{% include "modals/capacity_simulation.html" %}
{% endblock %}

{% block scripts %}
<style>
#graph-overview-info {
    border-left: 1px solid #ccc;
    height: 100%;
}
#graph-overview-info ul li {
    border-bottom: 1px solid #ccc;
    height: 85px;
    width: 95%;
    position: relative;
    top: -25px;
}
#graph-overview-info ul li h3 {
    display: inline-block;
    margin-right: 15px;
    color: #B6B5B5;
    font-weight: 300;
    font-size: 38px;
}
#graph-overview-info ul li span {
    display: inline-block;
    color: #B6B5B5;
    font-size: 21px;
    font-weight: 300;
}
.grid-stack-item {
    margin:1% 0%;
    padding: 0% 1% !important;
}
.grid-stack-item-content {
    right:0px;
    left:0px;
}
.panel .panel-body {
    padding: 1%;
    position: relative;
}
.panel .panel-body .panel-loader{
    -moz-border-radius:0 0 4px 4px;
    -webkit-animation:fadeIn .2s;
    -webkit-border-radius:0 0 4px 4px;
    animation:fadeIn .2s;
    background:#fff;
    border-radius:0 0 4px 4px;
    bottom:0;
    filter:alpha(opacity=90);
    left:0;
    opacity:.9;
    position:absolute;
    right:0;
    top:0;
    z-index:1020;
}
.panel .panel-heading .tools a {
    text-decoration: none;margin-left: 10px;color: #a7a7a7;font-size: 12px;
}
.panel-loader {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0px;
    left: 0px;
    z-index:10;
}
.panel-loader i {
    top: 40%;
    left: 45%;
    position: absolute;
    transform: translateY(-50%) translateX(-50%);
}
</style>

<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>

<link  href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css" rel="stylesheet"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
    
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>

<link  href="{{ config['CDN_LOCAL'] }}/extras/gridstack/0.3.0/css/gridstack.min.css" rel="stylesheet"/>
<script src="{{ config['CDN_LOCAL'] }}/extras/gridstack/0.3.0/js/gridstack.all.js"></script>
<script src="{{ config['CDN_LOCAL'] }}/extras/gridstack/0.3.0/js/gridstack.jQueryUI.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>

<link  href="//cdnjs.cloudflare.com/ajax/libs/c3/0.6.1/c3.min.css" rel="stylesheet"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/c3/0.6.1/c3.min.js"></script>

<link  href="{{ config['CDN_LOCAL'] }}/extras/bootstrap-wizard/1.0.0/css/bootstrap-wizard.css" rel="stylesheet" />
<script src="{{ config['CDN_LOCAL'] }}/extras/bootstrap-wizard/1.0.0/js/bootstrap-wizard.js" type="text/javascript"></script>

<link  href="//cdn.rawgit.com/amoffat/bootstrap-application-wizard/master/demo/chosen/chosen.css" rel="stylesheet"/>
<script src="//cdn.rawgit.com/amoffat/bootstrap-application-wizard/master/demo/chosen/chosen.jquery.js" ></script>

<link  href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.css" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.js"></script>

<link  href="{{ config['CDN_LOCAL'] }}/extras/bootstrap-select/1.12.4/css/bootstrap-select.min.css" rel="stylesheet">
<script src="{{ config['CDN_LOCAL'] }}/extras/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>

<script>
$(document).ready(function () {
    var details_data = [];
    var graph_overview_perf = c3.generate({
	bindto: '#graph-overview-perf',
	data: {
	    type: 'gauge',
	    columns: [
		['cpu'],
		['memory'],
		['storage'],
	    ]
	},
	gauge: {
	    label: {
		show: true
	    }
	},
	transition: {
	    duration: 1000
	},
	size: {
	    height: 200
	}
    });
    $('.grid-stack').gridstack();
    $('.chzn-select').chosen();

    
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
	jqlisteners();
    });

    $(window).resize(function () {
	jqlisteners();
    });
    $('.modal').on('shown.bs.modal', function() {
	autosize_tables();
	jqlisteners();
    });
    $('.modal').on('hidden.bs.modal', function(){
	$('.modal').find('.modal-title').html('New');
	var forms = $(this).find('form');
	forms.each(function(row){
	    forms[row].reset();
	});
	var selectpickers = $(this).find('.selectpicker');
	selectpickers.each(function(row){
	    $(selectpickers[row]).selectpicker('refresh');
	});
    });
    autosize_tables();
    jqlisteners();
    
    var wizard = $("#wizard-alloc").wizard({
	contentHeight : 600,
	contentWidth : 900,
	showCancel: true,
    });

    wizard.on('closed', function() {
	wizard.reset();
    });

    wizard.on("reset", function() {
	wizard.modal.find(':input').val('').removeAttr('disabled');
	wizard.modal.find('.form-group').removeClass('has-error').removeClass('has-succes');
	wizard.modal.find('#fqdn').data('is-valid', 0).data('lookup', 0);
	autosize_tables();
    });

    wizard.on("submit", function(wizard) {
	console.log('seralize()');
	console.log(this.serialize());
	console.log('serializeArray()');
	console.log(this.serializeArray());

	setTimeout(function() {
	    wizard.trigger("success");
	    wizard.hideButtons();
	    wizard._submitting = false;
	    wizard.showSubmitCard("success");
	    wizard.updateProgressBar(0);
	}, 2000);
    });

    wizard.cards["properties"].on("selected", function(card) {
    	setTimeout(function () {
    	    autosize_tables('#table-properties');
    	}, 200);
    });
    
    wizard.on("incrementCard", function(wizard) {
	var options = wizard.serializeArray();
	if ( wizard.getActiveCard()["name"] == 'hosts' ) {
	    autosize_tables('#table-hosts');
	    $('#table-hosts').bootstrapTable('load', HostsScoreCalc(details_data, options));
	}
    });

    wizard.el.find(".wizard-success .im-done").click(function() {
	wizard.hide();
	setTimeout(function() {
	    wizard.reset();
	}, 250);

    });

    wizard.el.find(".wizard-success .create-another-server").click(function() {
	wizard.reset();
    });
    
    $(document).on("click", "[data-click=section-simulation]", function(a) {
	a.preventDefault();
	wizard.show();
    });
    
    setTimeout(function () {
	var data = fetch_data();
	if ( data.length > 0 ) {
	    details_data = data
	}
	OverviewLoad(details_data, graph_overview_perf);
	DetailsLoad(details_data);
    }, 1000);
});

{% include "modals/js/capacity_simulation.js" %}

function jqlisteners() {
    console.log(1);
};
function ComputeResources(res) {
    console.log(res);
};
function validateInput(el) {
    var name  = el[0].name;
    var value = el.val();
    var rval  = {};

    if (value == "") {
	rval.status = false;
	rval.msg = "Please fill in this value."
    } else {
	rval.status = true;
    }
    console.log(el, name, value, rval);
    return rval;
};
function fetch_data(details_data) {
    var data = [];
    $.ajax({
	async: false,
	type: "GET",
	url: "{{ url_for('api_capacity') }}",
	success: function (e) {
	    var raw = e['data'];
	    for(r in raw) {
		var sw = raw[r].inventory.software_full
		if ( sw ) {
		    sw = JSON.parse(sw);
		    if ( sw.apps && sw.apps.kvm ) {
			data.push({
			    "name": raw[r].host,
			    "kvm": sw.apps.kvm
			})
		    }
		}		
	    }
	}
    })
    return data
}
function OverviewLoad(dataset, graph_overview_perf) {
    var hosts = dataset.length;
    var domains = 0;
    var cpu_perc = 0;
    var mem_perc = 0;
    var str_perc = 0;

    for (hv in dataset) {
	var storage_total = 0;
	var storage_avail = 0;
	var memory_total  = 0;
	var memory_avail  = 0;
	var cpu_total     = 0;
	var cpu_avail     = 0;
	for (pool in dataset[hv]['kvm']['pools']) {
	    storage_total+=Number(dataset[hv]['kvm']['pools'][pool]['capacity']);
	    storage_avail+=Number(dataset[hv]['kvm']['pools'][pool]['available']);
	}

	var mem_usage = 0;
	var cpu_usage = 0;
	for (dom in dataset[hv]['kvm']['domains']) {
	    mem_usage+=Number(dataset[hv]['kvm']['domains'][dom]['memory']);
	    cpu_usage+=Number(dataset[hv]['kvm']['domains'][dom]['vcpu']);
	}

	domains+=dataset[hv]['kvm']['domains'].length;
	str_perc+=( (storage_avail * 100) / storage_total);
	mem_perc+=( (mem_usage * 100) / Number(dataset[hv]['kvm']['node']['memory_size']) )
	cpu_perc+=( (cpu_usage * 100) / Number(dataset[hv]['kvm']['node']['cpu_count']) )
    }
    
    str_perc = (str_perc / hosts)
    mem_perc = (mem_perc / hosts)
    cpu_perc = (cpu_perc / hosts)
    
    graph_overview_perf.load({
	columns: [
	    ['cpu',     cpu_perc.toFixed(2)],
	    ['memory',  mem_perc.toFixed(2)],
	    ['storage', str_perc.toFixed(2)]
	]
    });
    $('#overview-hosts-count h3').html(hosts);
    $('#overview-vms-count h3').html(domains);
}
function DetailsLoad(dataset) {
    var html = '';
    for (data in dataset) {
	var storage_size_total = 0;
	var storage_size_avail = 0;
	for (pool in dataset[data]['kvm']['pools']) {
	    storage_size_total+=Number(dataset[data]['kvm']['pools'][pool]['capacity']);
	    storage_size_avail+=Number(dataset[data]['kvm']['pools'][pool]['available']);
	}
	html+='<table class="table table-striped table-sm table-bordered table-hover">';
	html+=' <thead style="background: #ededed;">';
	html+='  <tr>';
	html+='   <th colspan="4" class="bg-default" style="text-align: center;">';
	html+=     dataset[data]['name'];
	html+='    <br>';
	html+='    <span>';
	html+='     <i class="fa fa-fw fa-microchip"></i> ';
	html+=      dataset[data]['kvm']['node']['cpu_count'];
	html+='    </span>';
	html+='    <i class="fa fa-fw fa-ellipsis-v"></i>';
	html+='    <span>';
	html+='     <i class="fa fa-fw fa-memory"></i> ';
	html+=      humanSize(dataset[data]['kvm']['node']['memory_size']);
	html+='    </span>';
	html+='    <i class="fa fa-fw fa-ellipsis-v"></i>';
	html+='    <span>';
	html+='     <i class="fa fa-fw fa-database"></i> ';
	html+=      humanSize(storage_size_total) + ' (' + dataset[data]['kvm']['pools'].length + ')'; 
	html+='    </span>';
	// html+='    <i class="fa fa-fw fa-ellipsis-v"></i>';
	// html+='    <span>';
	// html+='     <i class="fa fa-fw fa-globe"></i> ';
	// html+=      dataset[data]['kvm']['pools'].length; 
	// html+='    </span>';
	html+='   </th>';
	html+='  </tr>';
	html+='  <tr>';
	html+='   <th scope="col" class="col-md-3">';
	html+='    <span>';
	html+='     <i class="fa fa-fw fa-box"></i> Domain';
	html+='    </span>';
	html+='   </th>';
	html+='   <th scope="col" class="col-md-3">';
	html+='    <span class="pull-right">';
	html+='     <i class="fa fa-fw fa-microchip"></i> vCPU';
	html+='    </span>';
	html+='   </th>';
	html+='   <th scope="col" class="col-md-3">';
	html+='    <span class="pull-right">';
	html+='     <i class="fa fa-fw fa-memory"></i> Memory';
	html+='    </span>';
	html+='   </th>';
	html+='   <th scope="col" class="col-md-3">';
	html+='    <span class="pull-right">';
	html+='     <i class="fa fa-fw fa-database"></i> Storage';
	html+='    </span>';
	html+='   </th>';
	html+='</tr>'
	html+='</thead>';
	html+='<tbody>'
	subtotal = { "domains": 0, "vcpu": 0, "memory": 0, "storage": 0 }
	for (dom in dataset[data]['kvm']['domains']) {
	    html+='<tr>';
	    html+=' <th scope="row">';
	    html+='  <span>';
	    if (dataset[data]['kvm']['domains'][dom]['status'] == 'running') {
		html+='<i class="fa fa-fw fa-check-circle status-green"></i> ';
	    } else {
		html+='<i class="fa fa-fw fa-exclamation-triangle status-red"></i> ';
	    }
	    html+=    dataset[data]['kvm']['domains'][dom]['name'];
	    html+='  </span>';
	    html+='  <span class="vm-opts pull-right">'
	    if (dataset[data]['kvm']['domains'][dom]['autostart'] == 'enable') {
		html+='<i class="fa fa-fw fa-stopwatch status-green" title="Autostart=yes"></i>';
	    } else {
		html+='<i class="fa fa-fw fa-stopwatch status-red" title="Autostart=no"></i>';
	    }
	    if (dataset[data]['kvm']['domains'][dom]['persistent'] == 'yes') {
		html+='<i class="fa fa-fw fa-anchor status-green" title="Persistent=yes"></i>';
	    } else {
		html+='<i class="fa fa-fw fa-anchor status-red" title="Persistent=no"></i>';
	    }
	    html+='  </span>'
	    html+=' </th>';
	    html+=' <th scope="row">';
	    html+='  <span class="pull-right">';
	    html+=    dataset[data]['kvm']['domains'][dom]['vcpu'];
	    html+='  </span>';
	    html+=' </th>';
	    html+=' <th scope="row">';
	    html+='  <span class="pull-right">';
	    html+=    humanSize(dataset[data]['kvm']['domains'][dom]['memory']);
	    html+='  </span></th>';
	    html+=' <th scope="row">';
	    html+='  <span class="pull-right">';
	    html+=    humanSize(dataset[data]['kvm']['domains'][dom]['storage_capacity']);
	    html+='  </span>';
	    html+=' </th>';
	    html+='</tr>';

	    subtotal['domains'] += 1;
	    subtotal['vcpu']    += Number(dataset[data]['kvm']['domains'][dom]['vcpu']);
	    subtotal['memory']  += Number(dataset[data]['kvm']['domains'][dom]['memory']);
	    subtotal['storage'] += Number(dataset[data]['kvm']['domains'][dom]['storage_alloc']);
	}
	
	html+='</tbody>';
	html+='<tfoot>'
	html+=' <tr style="font-style:italic;background: #e5e5e5">';
	html+='  <th scope="col">Allocated</th>';
	html+='  <th scope="col">';
	html+='   <span class="pull-right">'
	html+=     subtotal['vcpu'];
	html+='   </span>';
	html+='  </th>';
	html+='  <th scope="col">';
	html+='   <span class="pull-right">'
	html+=     humanSize(subtotal['memory']);
	html+='   </span>';
	html+='  </th>';
	html+='  <th scope="col">';
	html+='   <span class="pull-right">'
	html+=     humanSize(subtotal['storage']);
	html+='   </span>';
	html+='  </th>';
	html+=' </tr>';
	html+=' <tr style="font-style:italic; background:#bfccb7">';
	html+='  <th scope="col">Available</th>';
	html+='  <th scope="col">';
	html+='   <span class="pull-right">'
	html+=     dataset[data]['kvm']['node']['cpu_count'] - subtotal['vcpu']
	html+='   </span>';
	html+='  </th>';
	html+='  <th scope="col">';
	html+='   <span class="pull-right">'
	html+=     humanSize(dataset[data]['kvm']['node']['memory_size'] - subtotal['memory']);
	html+='   </span>';
	html+='  </th>';
	html+='  <th scope="col">';
	html+='   <span class="pull-right">'
	html+=     humanSize(storage_size_avail);
	html+='   </span>';
	html+='  </th>';
	html+=' </tr>';
	html+='</tfoot>'
	html+='<caption align="bottom">';
	html+=  subtotal['domains'] + ' domains';
	if ( subtotal['vcpu'] > dataset[data]['kvm']['node']['cpu_count'] ) {
	    html+=' with CPU overcommit.'
	}
	html+='</caption>'
	html+='</table>';
    }
    $('#details-content').html(html);
};
function autosize_tables(selected) {
    if ( selected == null || selected === '' ) {
	var tables = $('body').find(".table-autosize");
    } else {
	var tables = $('body').find(selected);
    }
    tables.each(function(row){
	var selector = $(tables[row]).attr('id');
	selector = '#' + selector;
	$(selector).on('post-body.bs.table', function () {
	    jqlisteners();
	});
	$(selector).bootstrapTable({
            height: table_height(selector),
	});
	$(selector).bootstrapTable('resetView', {
            height: table_height(selector),
	});
    });
}
function table_height(table) {
    var parent = $(table).parent().parent().parent().parent();
    return parent.height();
};
function humanSize(bytes, si=false) {
    var thresh = si ? 1000 : 1024;
    if(Math.abs(bytes) < thresh) {
	return bytes + ' B';
    }
    var units = si
        ? ['kB','MB','GB','TB','PB','EB','ZB','YB']
        : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
    var u = -1;
    do {
	bytes /= thresh;
	++u;
    } while(Math.abs(bytes) >= thresh && u < units.length - 1);
    return bytes.toFixed(1)+' '+units[u];
}
</script>
{% endblock %}
